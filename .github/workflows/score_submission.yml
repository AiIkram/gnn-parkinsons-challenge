name: Score Submission

on:
  pull_request:
    paths:
      - submissions/encrypted/**
    types:
      - opened
      - synchronize
      - reopened

jobs:
  score:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
      issues: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 2
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'
      
      - name: Install dependencies
        run: pip install pandas scikit-learn numpy torch cryptography
      
      - name: Get submitter username
        id: user
        run: echo "username=${{ github.event.pull_request.user.login }}" >> $GITHUB_OUTPUT
      
     
      
      - name: Find encrypted file
        id: find
        if: steps.check.outcome == 'success'
        run: |
          FILE=$(find submissions/encrypted -name "*.enc" -type f 2>/dev/null | head -1)
          if [ -z "$FILE" ]; then
            echo "No .enc file found"
            exit 1
          fi
          echo "file=$FILE" >> $GITHUB_OUTPUT
          echo "Found: $FILE"
      
      - name: Load private key
        if: steps.check.outcome == 'success'
        run: |
          echo "${{ secrets.PRIVATE_KEY }}" > encryption/private_key.pem
          chmod 600 encryption/private_key.pem
      
      - name: Decrypt submission
        id: decrypt
        if: steps.check.outcome == 'success'
        run: |
          python encryption/decrypt_submission.py "${{ steps.find.outputs.file }}" encryption/private_key.pem
          DECRYPTED="${{ steps.find.outputs.file }}"
          DECRYPTED="${DECRYPTED%.enc}_decrypted.csv"
          echo "csv=$DECRYPTED" >> $GITHUB_OUTPUT
        continue-on-error: true
      
      - name: Validate and Score
        id: score
        if: steps.decrypt.outcome == 'success'
        env:
          TEST_LABELS: ${{ secrets.TEST_LABELS }}
        run: |
          echo "$TEST_LABELS" > /tmp/ground_truth.csv
          RESULT=$(python scripts/scoring_script.py "${{ steps.decrypt.outputs.csv }}" "${{ steps.user.outputs.username }}" /tmp/ground_truth.csv 2>&1)
          echo "$RESULT"
          SCORE=$(echo "$RESULT" | grep "Score:" | tail -1 | awk '{print $NF}')
          
          if [ -z "$SCORE" ] || [ "$SCORE" = "nan" ] || [ "$SCORE" = "NaN" ]; then
            echo "Scoring failed - no valid score found"
            exit 1
          fi
          
          echo "score=$SCORE" >> $GITHUB_OUTPUT
        continue-on-error: true
      
      - name: Cleanup sensitive files
        if: always()
        run: |
          rm -f encryption/private_key.pem
          rm -f /tmp/ground_truth.csv
          rm -f "${{ steps.decrypt.outputs.csv }}"
      
      - name: Save to leaderboard CSV
        if: steps.score.outcome == 'success'
        run: |
          mkdir -p docs
          TIMESTAMP=$(date -u +"%Y-%m-%d")
          
          # Create CSV with correct format if it doesn't exist
          if [ ! -f "docs/leaderboard.csv" ]; then
            echo "team,score,model,date,notes" > docs/leaderboard.csv
          fi
          
          # Add entry: team=username, model=GNN (default), notes=GitHub username
          echo "${{ steps.user.outputs.username }},${{ steps.score.outputs.score }},GNN,$TIMESTAMP,${{ steps.user.outputs.username }}" >> docs/leaderboard.csv
          
          # Commit and push
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/leaderboard.csv
          git commit -m "Add submission for ${{ steps.user.outputs.username }} [skip ci]"
          git push origin HEAD:main
      
      - name: Get rank
        id: rank
        if: steps.score.outcome == 'success'
        run: |
          python3 << 'PYEOF'
          import pandas as pd
          import sys
          
          try:
              df = pd.read_csv('docs/leaderboard.csv')
              df = df.sort_values('score', ascending=False)
              df['rank'] = df['score'].rank(method='min', ascending=False).astype(int)
              
              username = "${{ steps.user.outputs.username }}"
              user_rank = df[df['team'] == username]['rank'].values[0]
              
              with open('$GITHUB_OUTPUT', 'a') as f:
                  f.write(f"rank={user_rank}\n")
          except Exception as e:
              print(f"Error calculating rank: {e}")
              sys.exit(1)
          PYEOF
      
      - name: Comment Score
        if: steps.score.outcome == 'success' && steps.rank.outcome == 'success'
        uses: actions/github-script@v6
        with:
          script: |
            const score = '${{ steps.score.outputs.score }}';
            const rank = '${{ steps.rank.outputs.rank }}';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## ðŸŽ¯ Submission Scored Successfully!\n\n'
                + '**Your Results:**\n'
                + '- ðŸ“Š **F1-Score:** `' + score + '`\n'
                + '- ðŸ† **Rank:** #' + rank + '\n\n'
                + '---\n\n'
                + '### ðŸ”’ Security Process:\n'
                + 'âœ… Encrypted on your machine\n'
                + 'âœ… Decrypted securely in GitHub Actions\n'
                + 'âœ… Scored against hidden test labels\n'
                + 'âœ… Immediately deleted (no trace)\n\n'
                + '**Your predictions remain 100% private!**\n\n'
                + '---\n\n'
                + 'âš ï¸ **Important:** This was your **ONE** allowed submission.\n\n'
                + 'ðŸ“Š [View Leaderboard](../blob/main/LEADERBOARD.md)'
            });
      
      - name: Comment if already submitted
        if: steps.check.outcome == 'failure'
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## âŒ Already Submitted\n\nOnly **ONE** submission per participant.\n\nYour previous submission stands as your final entry.'
            });
      
      - name: Comment if decryption failed
        if: steps.decrypt.outcome == 'failure'
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## âŒ Decryption Failed\n\nYour file could not be decrypted. This attempt does **not** count.\n\n**Fix:**\n```bash\npython encryption/encrypt_submission.py submissions/your_predictions.csv\n```\n\nClose this PR and open a new one with the fresh file.'
            });
      
      - name: Comment if scoring failed
        if: steps.score.outcome == 'failure' && steps.decrypt.outcome == 'success'
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## âŒ Scoring Failed\n\nDecryption succeeded but scoring failed. This attempt does **not** count.\n\n**Possible reasons:**\n- Ground truth labels not configured in GitHub Secrets\n- Invalid submission format\n\n**Required format:**\n```csv\nnode_id,prediction\n0,1\n1,0\n...\n38,0\n```\n\nExactly 39 rows, `node_id` 0-38, `prediction` 0 or 1 only.'
            });
