name: Score Submission

on:
  pull_request:
    paths:
      - submissions/encrypted/**
    types:
      - opened
      - synchronize
      - reopened

jobs:
  score:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
      issues: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 2
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'
      
      - name: Install dependencies
        run: pip install pandas scikit-learn numpy torch cryptography
      
      - name: Get submitter username
        id: user
        run: echo "username=\${{ github.event.pull_request.user.login }}" >> \$GITHUB_OUTPUT
      
      - name: Check one-submission rule
        id: check
        env:
          SUBMITTER: \${{ steps.user.outputs.username }}
        run: |
          cat > /tmp/check_sub.py << 'PYEOF'
          import json, os, sys
          log_file = "submissions/submission_log.json"
          log = json.load(open(log_file)) if os.path.exists(log_file) else {}
          username = os.environ["SUBMITTER"]
          if username in log:
              print("REJECTED: " + username + " already submitted on " + log[username]["date"])
              sys.exit(1)
          print("ALLOWED: first submission for " + username)
          PYEOF
          python3 /tmp/check_sub.py
        continue-on-error: true
      
      - name: Find encrypted file
        id: find
        if: steps.check.outcome == 'success'
        run: |
          FILE=\$(find submissions/encrypted -name "*.enc" -type f 2>/dev/null | head -1)
          if [ -z "\$FILE" ]; then
            echo "No .enc file found"
            exit 1
          fi
          echo "file=\$FILE" >> \$GITHUB_OUTPUT
          echo "Found: \$FILE"
      
      - name: Load private key
        if: steps.check.outcome == 'success'
        run: |
          echo "\${{ secrets.PRIVATE_KEY }}" > encryption/private_key.pem
          chmod 600 encryption/private_key.pem
      
      - name: Decrypt submission
        id: decrypt
        if: steps.check.outcome == 'success'
        run: |
          python encryption/decrypt_submission.py "\${{ steps.find.outputs.file }}" encryption/private_key.pem
          DECRYPTED="\${{ steps.find.outputs.file }}"
          DECRYPTED="\${DECRYPTED%.enc}_decrypted.csv"
          echo "csv=\$DECRYPTED" >> \$GITHUB_OUTPUT
        continue-on-error: true
      
      - name: Validate and Score
        id: score
        if: steps.decrypt.outcome == 'success'
        env:
          TEST_LABELS: \${{ secrets.TEST_LABELS }}
        run: |
          echo "\$TEST_LABELS" > /tmp/ground_truth.csv
          RESULT=\$(python scripts/scoring_script.py "\${{ steps.decrypt.outputs.csv }}" "\${{ steps.user.outputs.username }}" 2>&1)
          echo "\$RESULT"
          SCORE=\$(echo "\$RESULT" | grep "Score:" | tail -1 | awk '{print \$NF}')
          RANK=\$(echo "\$RESULT" | grep "Rank:" | head -1 | awk '{print \$NF}' | grep -o '[0-9]*')
          echo "score=\$SCORE" >> \$GITHUB_OUTPUT
          echo "rank=\$RANK" >> \$GITHUB_OUTPUT
        continue-on-error: true
      
      - name: Cleanup sensitive files
        if: always()
        run: |
          rm -f encryption/private_key.pem
          rm -f /tmp/ground_truth.csv
          rm -f "\${{ steps.decrypt.outputs.csv }}"
      
      - name: Record and update leaderboard
        if: steps.score.outcome == 'success'
        env:
          SUBMITTER: \${{ steps.user.outputs.username }}
          FILEPATH: \${{ steps.find.outputs.file }}
          SCORE: \${{ steps.score.outputs.score }}
        run: |
          cat > /tmp/record_sub.py << 'PYEOF'
          import json, os
          from datetime import datetime
          
          log_file = "submissions/submission_log.json"
          log = json.load(open(log_file)) if os.path.exists(log_file) else {}
          
          log[os.environ["SUBMITTER"]] = {
              "date": datetime.utcnow().strftime("%Y-%m-%d %H:%M UTC"),
              "score": float(os.environ["SCORE"]),
              "file": os.environ["FILEPATH"]
          }
          
          os.makedirs("submissions", exist_ok=True)
          json.dump(log, open(log_file, "w"), indent=2)
          
          entries = [{"anon": "Anonymous_{:03d}".format(i), "score": v["score"], "date": v["date"][:10]} for i, (k, v) in enumerate(log.items(), 1)]
          entries.sort(key=lambda x: x["score"], reverse=True)
          
          rank = 1
          for i, e in enumerate(entries):
              if i > 0 and entries[i]["score"] < entries[i-1]["score"]:
                  rank = i + 1
              e["rank"] = rank
          
          medals = {1: "\U0001F947", 2: "\U0001F948", 3: "\U0001F949"}
          now = datetime.utcnow().strftime("%Y-%m-%d %H:%M UTC")
          rows = ["| {}{} | {} | {:.4f} | {} |".format(medals.get(e["rank"],""), e["rank"], e["anon"], e["score"], e["date"]) for e in entries]
          
          body = "# Leaderboard\n\n> Privacy: Submissions anonymized. Only scores and ranks shown.\n> Ranking: Tied scores share same rank (Kaggle-style).\n\nLast updated: {}\n\n| Rank | Participant | Macro F1-Score | Date |\n|:----:|-------------|:--------------:|------|\n{}\n\n---\n\nOnly **one submission** per participant.\n".format(now, "\n".join(rows))
          
          open("LEADERBOARD.md", "w", encoding="utf-8").write(body)
          print("Done")
          PYEOF
          
          python3 /tmp/record_sub.py
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add submissions/submission_log.json LEADERBOARD.md
          git commit -m "Leaderboard update [skip ci]" || echo "Nothing to commit"
          git push origin HEAD:main
      
      - name: Comment Score
        if: steps.score.outcome == 'success'
        uses: actions/github-script@v6
        with:
          script: |
            const score = '\${{ steps.score.outputs.score }}';
            const rank = '\${{ steps.score.outputs.rank }}';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## üéØ Submission Scored Successfully!\n\n'
                + '**Your Results:**\n'
                + '- üìä **F1-Score:** `' + score + '`\n'
                + '- üèÜ **Rank:** #' + rank + '\n\n'
                + '---\n\n'
                + '### üîí Security Process:\n'
                + '‚úÖ Encrypted on your machine\n'
                + '‚úÖ Decrypted securely in GitHub Actions\n'
                + '‚úÖ Scored against hidden test labels\n'
                + '‚úÖ Immediately deleted (no trace)\n\n'
                + '**Your predictions remain 100% private!**\n\n'
                + '---\n\n'
                + '‚ö†Ô∏è **Important:** This was your **ONE** allowed submission.\n\n'
                + 'üìä [View Leaderboard](../blob/main/LEADERBOARD.md)'
            });
      
      - name: Comment if already submitted
        if: steps.check.outcome == 'failure'
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## ‚ùå Already Submitted\n\nOnly **ONE** submission per participant.\n\nYour previous submission stands as your final entry.'
            });
      
      - name: Comment if decryption failed
        if: steps.decrypt.outcome == 'failure'
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## ‚ùå Decryption Failed\n\nYour file could not be decrypted. This attempt does **not** count.\n\n**Fix:**\n```bash\npython encryption/encrypt_submission.py submissions/your_predictions.csv\n```\n\nClose this PR and open a new one with the fresh file.'
            });
      
      - name: Comment if scoring failed
        if: steps.score.outcome == 'failure' && steps.decrypt.outcome == 'success'
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## ‚ùå Scoring Failed\n\nDecryption succeeded but scoring failed. This attempt does **not** count.\n\n**Required format:**\n```csv\nnode_id,prediction\n0,1\n1,0\n...\n38,0\n```\n\nExactly 39 rows, `node_id` 0-38, `prediction` 0 or 1 only.'
            });
